name: Build & Release Multi-Platform

on:
  push:
    branches: ['**']
    tags: ['v*.*.*']
  pull_request:

jobs:
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            artifact: kPen-Windows.exe
            artifact_path: build/Release/kPen.exe

          - os: ubuntu-latest
            artifact: kPen-Linux
            artifact_path: build/kPen

          - os: macos-latest
            artifact: kPen-Mac.dmg
            artifact_path: kPen-*.dmg

    steps:
      - uses: actions/checkout@v4

      # ── Windows ──────────────────────────────────────────────────────────────
      - name: Windows — Setup vcpkg
        if: matrix.os == 'windows-latest'
        uses: lukka/run-vcpkg@v11

      - name: Windows — Build
        if: matrix.os == 'windows-latest'
        run: |
          cmake -B build -S . `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET=x64-windows-static `
            -DCMAKE_CXX_FLAGS="/DSDL_MAIN_HANDLED" `
            -DCMAKE_EXE_LINKER_FLAGS="/SUBSYSTEM:WINDOWS /ENTRY:mainCRTStartup"
          cmake --build build --config Release

      # ── Linux ─────────────────────────────────────────────────────────────────
      - name: Linux — Install SDL2 & Build
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libsdl2-dev
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release
          cmake --build build --parallel

      # ── macOS ─────────────────────────────────────────────────────────────────
      - name: macOS — Install SDL2 & Build
        if: matrix.os == 'macos-latest'
        run: |
          brew install sdl2
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release
          cmake --build build --parallel

      - name: macOS — Sign & Package DMG
        if: matrix.os == 'macos-latest'
        run: |
          # Ad-hoc sign the app (no Apple Developer account required)
          codesign --deep --force --sign - build/kPen.app

          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF_NAME#v}"
          else
            VERSION="dev-${GITHUB_SHA::7}"
          fi

          mkdir dmg_stage
          cp -r build/kPen.app dmg_stage/
          ln -s /Applications dmg_stage/Applications
          hdiutil create \
            -volname kPen \
            -srcfolder dmg_stage \
            -ov -format UDZO \
            "kPen-${VERSION}.dmg"

      # ── Upload artifacts (all branches) ──────────────────────────────────────
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact_path }}

  # ── Release job — only runs on version tags ───────────────────────────────────
  release:
    name: Create GitHub Release
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      # actions/download-artifact@v4 nests each artifact under its name:
      #   artifacts/kPen-Mac.dmg/kPen-<version>.dmg
      - name: Compute macOS DMG SHA256
        id: sha
        run: |
          DMG=$(find artifacts/kPen-Mac.dmg -name '*.dmg' | head -1)
          echo "SHA256=$(shasum -a 256 "$DMG" | awk '{print $1}')" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/kPen-Windows.exe/kPen.exe
            artifacts/kPen-Mac.dmg/*.dmg
            artifacts/kPen-Linux/kPen
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger cask update
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.TAP_GITHUB_TOKEN }}
          repository: kaikino/homebrew-kpen
          event-type: update-cask
          client-payload: |
            {
              "version": "${{ steps.version.outputs.VERSION }}",
              "sha256": "${{ steps.sha.outputs.SHA256 }}",
              "url": "https://github.com/kaikino/kPen/releases/download/${{ github.ref_name }}/kPen-${{ steps.version.outputs.VERSION }}.dmg"
            }
